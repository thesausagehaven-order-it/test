<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
  // =========================
  // QUANTITY BUTTONS
  // =========================
  function increaseQty(qtyId) {
    const el = document.getElementById(qtyId);
    el.innerText = Number(el.innerText) + 1;
  }

  function decreaseQty(qtyId) {
    const el = document.getElementById(qtyId);
    if (Number(el.innerText) > 1) {
      el.innerText = Number(el.innerText) - 1;
    }
  }

  // =========================
  // CART LOGIC
  // =========================
  let cart = [];

  function addToCart(name, price, qtyId) {
    const qty = Number(document.getElementById(qtyId).innerText);
    if (qty < 1) return;

    // Check if item already exists
    const existingIndex = cart.findIndex(item => item.name === name);
    if (existingIndex >= 0) {
      cart[existingIndex].qty += qty;
    } else {
      cart.push({ name, qty, price });
    }

    updateCartBadge();
    renderCart();
    toggleCart();
  }

  function updateCartBadge() {
    const totalQty = cart.reduce((sum, i) => sum + i.qty, 0);
    const badge = document.getElementById("cartCount");
    badge.innerText = totalQty;
    badge.classList.remove("hidden");
  }

  function renderCart() {
    const container = document.getElementById("cartItems");
    container.innerHTML = "";
    let total = 0;

    cart.forEach(item => {
      const itemTotal = item.qty * item.price;
      total += itemTotal;

      container.innerHTML += `
        <div class="flex justify-between text-sm font-medium">
          <span>${item.name} × ${item.qty}</span>
          <span>GHS ${itemTotal.toFixed(2)}</span>
        </div>
      `;
    });

    document.getElementById("cartTotal").innerText = total.toFixed(2);
  }

  function toggleCart() {
    document.getElementById("cartDrawer").classList.toggle("translate-x-full");
  }

  // =========================
  // CHECKOUT MODAL
  // =========================
  function showCheckout() {
    if (cart.length === 0) {
      alert("Cart is empty");
      return;
    }
    document.getElementById("checkoutModal").classList.remove("hidden");
  }

  function closeCheckout() {
    document.getElementById("checkoutModal").classList.add("hidden");
  }

  // =========================
  // PAYMENT LOGIC
  // =========================
  async function payNow() {
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const location = document.getElementById("location").value.trim();
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;

    if (!name || !phone || !location) {
      alert("Fill all fields");
      return;
    }

    const total = cart.reduce((sum, i) => sum + i.qty * i.price, 0);
    const payload = { name, phone, location, cart, amount: total, paymentMethod };

    if (paymentMethod === "cod") {
      // COD: save directly
      await fetch("https://your-worker-domain.workers.dev", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      alert("Order placed! ✅");
      cart = [];
      renderCart();
      closeCheckout();
      return;
    }

    // Mobile Money (Paystack)
    PaystackPop.setup({
      key: "pk_test_1a654bb75fe2d39b626912eb42a2631b52bb0d03",
      email: `${phone}@sausagehaven.com`,
      amount: total * 100, // in pesewas
      currency: "GHS",
      metadata: {
        custom_fields: [
          { variable_name: "name", value: name },
          { variable_name: "phone", value: phone },
          { variable_name: "location", value: location }
        ],
        cart
      },
      callback: async function (res) {
        // Payment confirmed, save order to backend
        payload.reference = res.reference; // add Paystack reference
        await fetch("https://your-worker-domain.workers.dev", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        alert("Payment successful! ✅");
        cart = [];
        renderCart();
        closeCheckout();
      },
      onClose: function () {
        alert("Payment cancelled!");
      }
    }).openIframe();
  }
</script>
